<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>VPP运行在ARM板上 - Zhanggq</title>
  <link rel="alternate" hreflang="zh-cn" href="https://zhanggq.github.io/" />

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">


<meta name="author" content="Zhanggq" />
  <meta name="description" content="摘要 最近有个项目需要把VPP运行在ARM板子上，本篇文章主要记录一些操作过程： 环境信息； VPP交叉编译； UPF依赖交叉编译； 运行； 一、环境信" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.55.3" />


<link rel="canonical" href="https://zhanggq.github.io/post/zgq-dpdk-vpp-arm/" />



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" href="/favicon.ico" />
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">




<link href="/dist/jane.min.css?v=2.7.0" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">




<meta property="og:title" content="VPP运行在ARM板上" />
<meta property="og:description" content="摘要 最近有个项目需要把VPP运行在ARM板子上，本篇文章主要记录一些操作过程： 环境信息； VPP交叉编译； UPF依赖交叉编译； 运行； 一、环境信" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhanggq.github.io/post/zgq-dpdk-vpp-arm/" />
<meta property="article:published_time" content="2021-12-25T09:03:09&#43;08:00"/>
<meta property="article:modified_time" content="2021-12-25T10:03:09&#43;08:00"/>

<meta itemprop="name" content="VPP运行在ARM板上">
<meta itemprop="description" content="摘要 最近有个项目需要把VPP运行在ARM板子上，本篇文章主要记录一些操作过程： 环境信息； VPP交叉编译； UPF依赖交叉编译； 运行； 一、环境信">


<meta itemprop="datePublished" content="2021-12-25T09:03:09&#43;08:00" />
<meta itemprop="dateModified" content="2021-12-25T10:03:09&#43;08:00" />
<meta itemprop="wordCount" content="2647">



<meta itemprop="keywords" content="DPDK,VPP,ARM," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="VPP运行在ARM板上"/>
<meta name="twitter:description" content="摘要 最近有个项目需要把VPP运行在ARM板子上，本篇文章主要记录一些操作过程： 环境信息； VPP交叉编译； UPF依赖交叉编译； 运行； 一、环境信"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Jane</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">Jane</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        
        <a class="menu-item-link" href="/">Home</a>
        
      </li><li class="menu-item">
        
        <a class="menu-item-link" href="/post/">Archives</a>
        
      </li><li class="menu-item">
        
        <a class="menu-item-link" href="/tags/">Tags</a>
        
      </li><li class="menu-item">
        
        <a class="menu-item-link" href="/categories/">Categories</a>
        
      </li><li class="menu-item">
        
        <a class="menu-item-link" href="/about/">About</a>
        
      </li>
  </ul>
</nav>
  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">VPP运行在ARM板上</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-12-25 </span>
        <div class="post-category">
            
              <a href="/categories/dpdk/"> DPDK </a>
            
          </div>
        <span class="more-meta"> 约 2647 字 </span>
        <span class="more-meta"> 预计阅读 6 分钟 </span>
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#摘要">摘要</a></li>
<li><a href="#一-环境信息">一、环境信息</a></li>
<li><a href="#二-vpp交叉编译">二、VPP交叉编译</a></li>
<li><a href="#三-upf依赖交叉编译">三、UPF依赖交叉编译</a></li>
<li><a href="#四-upf加载">四、UPF加载</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<p><a name="section0"></a></p>

<h2 id="摘要">摘要</h2>

<blockquote>
<p>最近有个项目需要把VPP运行在ARM板子上，本篇文章主要记录一些操作过程：</p>

<ol>
<li>环境信息；</li>
<li>VPP交叉编译；</li>
<li>UPF依赖交叉编译；</li>
<li>运行；</li>
</ol>
</blockquote>

<p><a name="section1"></a></p>

<h2 id="一-环境信息">一、环境信息</h2>

<p>ARM板子硬件信息如下图所示：</p>

<p><img src="https://s2.loli.net/2022/01/28/75cbyYxuUEwTsiI.png" alt="图片" /></p>

<p><img src="https://s2.loli.net/2022/01/28/e9FJzjwIA6pTLNH.png" alt="图片" /></p>

<p>注：</p>

<p>Cortex-A72是基于ARMv8-A架构的CPU架构</p>

<p>系统信息如下：</p>

<pre><code class="language-shell">root@nrsys:~/board# cat /proc/version
Linux version 4.19.90-rt35 (root@comp-virtual-machine) (gcc version 7.5.0 (Ubuntu/Linaro 7.5.0-3ubuntu1~18.04)) #1 SMP PREEMPT RT Thu Aug 5 18:08:43 CST 2021

root@nrsys:~/board# lsb_release -a
No LSB modules are available.
Distributor ID: NXP-LSDK
Description:    main
Release:        testing/unstable
Codename:       bionic

root@nrsys:~/board# file /bin/ls
/bin/ls: ELF 64-bit LSB shared object, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, for GNU/Linux 3.7.0, BuildID[sha1]=de05fcef79d88af9cf9a71ed38e73af0b179bfb2, stripped

root@nrsys:~/board# cat /proc/cmdline
console=ttyAMA0,115200 earlycon=pl011,mmio32,0x21c0000 root=PARTUUID=b02cdacf-04 rw rootwait pci=pcie_bus_perf default_hugepagesz=1G hugepagesz=1G hugepages=4 isolcpus=1-15 nohz_full=1-15 rcu_nocbs=1-15 iommu.passthrough=1 irqaffinity=0 tsc=reliable mce=off idle=poll bootpart_ver=v21.04.01-55-g41b2e3c79 board=lx2160aMba uboot_ver=2019.10v21.04.01-55-g41b2e3c79

root@nrsys:~/board# cat /proc/meminfo | grep Huge
HugePages_Total:       4
HugePages_Free:        2
HugePages_Rsvd:        0
HugePages_Surp:        0
Hugepagesize:    1048576 kB
Hugetlb:         4194304 kB 
</code></pre>

<p>编译环境是ubuntu18.04，root用户在系统上安装编译工具：</p>

<pre><code class="language-shell">apt-get update
apt remove gcc-aarch64-linux-gnu
apt install gcc-aarch64-linux-gnu
apt install g++-aarch64-linux-gnu
aarch64-linux-gnu-gcc -v
</code></pre>

<p><img src="https://s2.loli.net/2022/01/28/IwpseKvNmu4nk1h.png" alt="图片" /></p>

<p><a name="section2"></a></p>

<h2 id="二-vpp交叉编译">二、VPP交叉编译</h2>

<p>首先看到VPP的RELEASE文件和dpaa.mk文件，感觉是恩智浦给VPP提供的编译脚本。</p>

<pre><code class="language-shell">[root@EMS vpp]# vi RELEASE.md
@page release_notes_1609 Release notes for VPP 16.09
## Features
- [Integrated July 2016 DPDK release](http://www.dpdk.org/doc/guides/rel_notes/release_16_07.html)
  - DPDK-vhost is depreciated pending a complete rework of the original integration and
    addressing of rx performance deltas.
  - Patches required for DPDK 16.07:
    - Correctly setting the Packet Type in the IGB, IXGBE and i40e drivers.
    - Correctly setting checksum in the i40e driver.
    - NXP DPAA2 PMD Driver.

[root@EMS platforms]# pwd
/home/C/vpp-upf/vpp/build-data/platforms
[root@EMS platforms]# 
[root@EMS platforms]# ll
-rw-r--r-- 1 root root 1709 Jun  9  2020 arm32.mk
-rw-r--r-- 1 root root 2948 Jun  9  2020 dpaa.mk
-rw-r--r-- 1 root root 1400 Jun  9  2020 qppc.mk
-rw-r--r-- 1 root root  952 Jun  9  2020 vpp.mk

[root@EMS platforms]# cat dpaa.mk 
# Copyright 2018 NXP
# Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at:
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Configuration for NXP DPAA1/DPAA2 ARM64 based platform
MACHINE=$(shell uname -m)

dpaa_mtune = cortex-A72
dpaa_march = &quot;armv8-a+fp+simd+crc+crypto&quot;

…………
</code></pre>

<p>在恩智浦官网查看，发现vpp 2101版本在恩智浦官方是支持的，其它的版本不一定支持，所以这次就用的这个版本。</p>

<ul>
<li>Numactl</li>
</ul>

<pre><code class="language-shell">cd /home/test/vpp_arm
mkdir numactl_install
git clone https://github.com/numactl/numactl.git
cd numactl/
git checkout v2.0.13
./autogen.sh
autoconf -i
./configure --host=aarch64-linux-gnu CC=aarch64-linux-gnu-gcc --prefix=/home/test/vpp_arm/numactl_install/
make install
export NUMA_PATH=/home/test/vpp_arm/numactl_install/lib

cp /home/test/vpp_arm/numactl_install/lib/include/numa*.h /usr/aarch64-linux-gnu/include/
cp /home/test/vpp_arm/numactl_install/include/numa*.h /usr/aarch64-linux-gnu/include/
cp /home/test/vpp_arm/numactl_install/lib/libnuma.a /usr/aarch64-linux-gnu/lib/
cp /home/test/vpp_arm/numactl_install/lib/libnuma.so /usr/aarch64-linux-gnu/lib/ 
</code></pre>

<ul>
<li>OPENSSL</li>
</ul>

<pre><code class="language-shell">cd /home/test/dpdk_arm/
mkdir openssl_install
git clone https://source.codeaurora.org/external/qoriq/qoriq-components/openssl -b integration 
cd openssl 
git checkout LSDK-21.08 
export CROSS_COMPILE=/usr/bin/aarch64-linux-gnu-
./Configure linux-aarch64 --prefix=/home/test/dpdk_arm/openssl_install shared
make depend
make
make install
export OPENSSL_PATH=/home/test/dpdk_arm/openssl_install 
</code></pre>

<ul>
<li>DPDK</li>
</ul>

<p><a href="https://doc.dpdk.org/guides-20.11/platform/dpaa2.html">NXP QorIQ DPAA2 Board Support Package</a>.</p>

<pre><code class="language-shell">cd /home/test/dpdk_arm/
mkdir dpdk_install
git clone https://source.codeaurora.org/external/qoriq/qoriq-components/dpdk -b integration
export CROSS_PATH=/usr
export PATH=$PATH:$CROSS_PATH
export PKG_CONFIG_LIBDIR=&quot;/home/test/dpdk_arm/openssl_install/lib/&quot; 
export PKG_CONFIG_PATH=$PKG_CONFIG_LIBDIR/pkgconfig
meson arm64-build --cross-file config/arm/arm64_dpaa_linux_gcc -Dexamples=all -Dc_args=&quot;-g -Ofast -fPIC -ftls-model=local-dynamic&quot; -Dprefix=/home/test/dpdk_arm/dpdk_install -Ddefault_library=static -Doptimization=3
ninja -C arm64-build
meson install -C arm64-build 
</code></pre>

<ul>
<li>VPP</li>
</ul>

<p>参考</p>

<p><a href="https://wiki.fd.io/view/VPP/AArch64">VPP</a></p>

<p><a href="https://github.com/contiv/vpp/blob/master/docs/arm64/MANUAL_INSTALL_ARM64.md">VPP-ARM64</a></p>

<p><a href="https://gitee.com/hehuiim/nxp-qoriq-components-vpp/blob/master/README_nxp.txt">nxp-qoriq-components-vpp</a></p>

<pre><code class="language-shell">git clone https://source.codeaurora.org/external/qoriq/qoriq-components/vpp 
git checkout 21.08-LSDK
export DPDK_PATH=/home/test/dpdk_arm/dpdk_install
export CROSS_TOOLCHAIN=/usr
export CROSS_PREFIX=aarch64-linux-gnu
export PLATFORM=dpaa
export PATH=/usr/bin:/usr/aarch64-linux-gnu/bin:$PATH
export OPENSSL_PATH=/home/test/dpdk_arm/openssl_install
export NUMA_PATH=/home/test/vpp_arm/numactl_install/lib
cd vpp
make install-dep
cd build-root
make distclean
make PLATFORM=dpaa TAG=dpaa vpp-package-deb V=0 
</code></pre>

<p><a name="section3"></a></p>

<h2 id="三-upf依赖交叉编译">三、UPF依赖交叉编译</h2>

<p>UPF编译依赖Hyperscan和zlog，编译过程如下:</p>

<ul>
<li>HYPERSCAN</li>
</ul>

<p>参考<a href="https://bbs.huaweicloud.com/forum/thread-42784-1-1.html">Hyperscan</a></p>

<pre><code class="language-shell">Cd /home/test/hyperscan

git clone https://github.com/kunpengcompute/hyperscan.git
或者自己下载
Wget https://github.com/kunpengcompute/hyperscan/archive/refs/tags/v5.3.0.aarch64.tar.gz
tar xvf ./v5.3.0.aarch64.tar.gz

wget https://boostorg.jfrog.io/artifactory/main/release/1.69.0/source/boost_1_69_0.tar.gz
tar xvf ./boost_1_69_0.tar.gz
cd hyperscan-5.3.0.aarch64/
ln -s /home/test/hyperscan/boost_1_69_0/boost include/boost

修改CMakeList.txt或者直接在cmake上添加参数也可以
set(CMAKE_SYSTEM_NAME Linux)
set(CMAKE_SYSTEM_PROCESSOR aarch64)

cmake -DBUILD_SHARED_LIBS=on -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=/usr/bin/aarch64-linux-gnu-gcc -DCMAKE_CXX_COMPILER=/usr/bin/aarch64-linux-gnu-g++
make -j8
cp /home/test/hyperscan/hyperscan-5.3.0.aarch64/lib/* /usr/aarch64-linux-gnu/lib/ 
</code></pre>

<ul>
<li>ZLOG</li>
</ul>

<p>参考<a href="https://blog.csdn.net/lc250123/article/details/54174401">Zlog</a></p>

<pre><code class="language-shell">root@ubuntu:/home/test# cd zlog-1.2.15-arm
root@ubuntu:/home/test/zlog-1.2.15-arm# ll
total 100
drwxr-xr-x  6 root root  4096 Dec 30 03:21 ./
drwxr-xr-x 22 test test  4096 Dec 30 03:21 ../
-rw-r--r--  1 root root   902 Dec 30 03:21 autogen.sh
-rw-r--r--  1 root root  5357 Dec 30 03:21 Changelog
-rw-r--r--  1 root root  1309 Dec 30 03:21 configure.ac
-rw-r--r--  1 root root 26530 Dec 30 03:21 COPYING
drwxr-xr-x  2 root root  4096 Dec 30 03:21 doc/
-rw-r--r--  1 root root   539 Dec 30 03:21 .gitignore
-rw-r--r--  1 root root  4537 Dec 30 03:21 INSTALL
-rw-r--r--  1 root root   421 Dec 30 03:21 makefile
-rw-r--r--  1 root root   124 Dec 30 03:21 Makefile.am
-rw-r--r--  1 root root  4537 Dec 30 03:21 README.md
drwxr-xr-x  2 root root  4096 Dec 30 03:21 src/
drwxr-xr-x  3 root root  4096 Dec 30 03:21 test/
-rw-r--r--  1 root root   603 Dec 30 03:21 TODO
drwxr-xr-x  2 root root  4096 Dec 30 03:21 tools/
root@ubuntu:/home/test/zlog-1.2.15-arm# chmod +x autogen.sh 
root@ubuntu:/home/test/zlog-1.2.15-arm# sh autogen.sh 
Finding version and setting it up for autoconf.... OK
Renaming original static makefiles.... OK
Running aclocal ..... aclocal: warning: couldn't open directory 'm4': No such file or directory
OK
Run libtoolize ..... libtoolize: putting auxiliary files in '.'.
libtoolize: copying file './ltmain.sh'
libtoolize: putting macros in AC_CONFIG_MACRO_DIRS, 'm4'.
libtoolize: copying file 'm4/libtool.m4'
libtoolize: copying file 'm4/ltoptions.m4'
libtoolize: copying file 'm4/ltsugar.m4'
libtoolize: copying file 'm4/ltversion.m4'
libtoolize: copying file 'm4/lt~obsolete.m4'
OK
Running autoconf ..... OK
Running automake ..... configure.ac:9: installing './compile'
configure.ac:14: installing './config.guess'
configure.ac:14: installing './config.sub'
configure.ac:11: installing './install-sh'
configure.ac:15: installing './missing'
OK
Now run ./configure &lt;parameters&gt; to configure application
root@ubuntu:/home/test/zlog-1.2.15-arm# CC=aarch64-linux-gnu-gcc ./configure --prefix=/opt/embedded/zlog --host=aarch64-linux-gnu
checking for aarch64-linux-gnu-gcc... aarch64-linux-gnu-gcc
checking whether the C compiler works... yes
checking for C compiler default output file name... a.out
checking for suffix of executables... 
checking whether we are cross compiling... yes
checking for suffix of object files... o
checking whether we are using the GNU C compiler... yes
checking whether aarch64-linux-gnu-gcc accepts -g... yes
checking for aarch64-linux-gnu-gcc option to accept ISO C89... none needed
checking whether aarch64-linux-gnu-gcc understands -c and -o together... yes
checking for a BSD-compatible install... /usr/bin/install -c
checking whether ln -s works... yes
checking whether make sets $(MAKE)... yes
checking build system type... x86_64-pc-linux-gnu
checking host system type... aarch64-unknown-linux-gnu
checking how to print strings... printf
checking for a sed that does not truncate output... /bin/sed
checking for grep that handles long lines and -e... /bin/grep
checking for egrep... /bin/grep -E
checking for fgrep... /bin/grep -F
checking for ld used by aarch64-linux-gnu-gcc... /usr/aarch64-linux-gnu/bin/ld
checking if the linker (/usr/aarch64-linux-gnu/bin/ld) is GNU ld... yes
checking for BSD- or MS-compatible name lister (nm)... /usr/bin/aarch64-linux-gnu-nm -B
checking the name lister (/usr/bin/aarch64-linux-gnu-nm -B) interface... BSD nm
checking the maximum length of command line arguments... 1572864
checking how to convert x86_64-pc-linux-gnu file names to aarch64-unknown-linux-gnu format... func_convert_file_noop
checking how to convert x86_64-pc-linux-gnu file names to toolchain format... func_convert_file_noop
checking for /usr/aarch64-linux-gnu/bin/ld option to reload object files... -r
checking for aarch64-linux-gnu-objdump... aarch64-linux-gnu-objdump
checking how to recognize dependent libraries... pass_all
checking for aarch64-linux-gnu-dlltool... no
checking for dlltool... no
checking how to associate runtime and link libraries... printf %s\n
checking for aarch64-linux-gnu-ar... aarch64-linux-gnu-ar
checking for archiver @FILE support... @
checking for aarch64-linux-gnu-strip... aarch64-linux-gnu-strip
checking for aarch64-linux-gnu-ranlib... aarch64-linux-gnu-ranlib
checking for gawk... gawk
checking command to parse /usr/bin/aarch64-linux-gnu-nm -B output from aarch64-linux-gnu-gcc object... ok
checking for sysroot... no
checking for a working dd... /bin/dd
checking how to truncate binary pipes... /bin/dd bs=4096 count=1
checking for aarch64-linux-gnu-mt... no
checking for mt... mt
configure: WARNING: using cross tools not prefixed with host triplet
checking if mt is a manifest tool... no
checking how to run the C preprocessor... aarch64-linux-gnu-gcc -E
checking for ANSI C header files... yes
checking for sys/types.h... yes
checking for sys/stat.h... yes
checking for stdlib.h... yes
checking for string.h... yes
checking for memory.h... yes
checking for strings.h... yes
checking for inttypes.h... yes
checking for stdint.h... yes
checking for unistd.h... yes
checking for dlfcn.h... yes
checking for objdir... .libs
checking if aarch64-linux-gnu-gcc supports -fno-rtti -fno-exceptions... no
checking for aarch64-linux-gnu-gcc option to produce PIC... -fPIC -DPIC
checking if aarch64-linux-gnu-gcc PIC flag -fPIC -DPIC works... yes
checking if aarch64-linux-gnu-gcc static flag -static works... yes
checking if aarch64-linux-gnu-gcc supports -c -o file.o... yes
checking if aarch64-linux-gnu-gcc supports -c -o file.o... (cached) yes
checking whether the aarch64-linux-gnu-gcc linker (/usr/aarch64-linux-gnu/bin/ld) supports shared libraries... yes
checking whether -lc should be explicitly linked in... no
checking dynamic linker characteristics... GNU/Linux ld.so
checking how to hardcode library paths into programs... immediate
checking whether stripping libraries is possible... yes
checking if libtool supports shared libraries... yes
checking whether to build shared libraries... yes
checking whether to build static libraries... yes
checking whether build environment is sane... yes
checking for aarch64-linux-gnu-strip... (cached) aarch64-linux-gnu-strip
checking for a thread-safe mkdir -p... /bin/mkdir -p
checking for style of include used by make... GNU
checking whether make supports nested variables... yes
checking dependency style of aarch64-linux-gnu-gcc... none
checking for pthread_create in -lpthread... yes
checking fcntl.h usability... yes
checking fcntl.h presence... yes
checking for fcntl.h... yes
checking limits.h usability... yes
checking limits.h presence... yes
checking for limits.h... yes
checking for stdint.h... (cached) yes
checking for stdlib.h... (cached) yes
checking for string.h... (cached) yes
checking for strings.h... (cached) yes
checking sys/time.h usability... yes
checking sys/time.h presence... yes
checking for sys/time.h... yes
checking syslog.h usability... yes
checking syslog.h presence... yes
checking for syslog.h... yes
checking for unistd.h... (cached) yes
checking for lyx... false
checking for hevea... false
checking for pid_t... yes
checking for size_t... yes
checking for uint32_t... yes
checking for uint64_t... yes
checking vfork.h usability... no
checking vfork.h presence... no
checking for vfork.h... no
checking for fork... yes
checking for vfork... yes
checking for working fork... cross
configure: WARNING: result yes guessed because of cross compilation
checking for working vfork... (cached) yes
checking whether lstat correctly handles trailing slash... no
checking for stdlib.h... (cached) yes
checking for GNU libc compatible realloc... no
checking for atexit... yes
checking for gethostname... yes
checking for gettimeofday... yes
checking for localtime_r... yes
checking for memmove... yes
checking for memset... yes
checking for setenv... yes
checking for strchr... yes
checking for strrchr... yes
checking for strtol... yes
checking that generated files are newer than configure... done
configure: creating ./config.status
config.status: creating doc/Makefile
config.status: creating Makefile
config.status: creating src/Makefile
config.status: creating test/Makefile
config.status: creating tools/Makefile
config.status: executing libtool commands
config.status: executing depfiles commands
root@ubuntu:/home/test/zlog-1.2.15-arm# make
/bin/bash ../libtool  --tag=CC   --mode=link aarch64-linux-gnu-gcc -I. -g -O2   -o zlog-chk-conf zlog_chk_conf-zlog-chk-conf.o libzlog.la -lpthread 
libtool: link: aarch64-linux-gnu-gcc -I. -g -O2 -o .libs/zlog-chk-conf zlog_chk_conf-zlog-chk-conf.o  ./.libs/libzlog.so -lpthread -Wl,-rpath -Wl,/opt/embedded/zlog/lib
./.libs/libzlog.so: undefined reference to `rpl_realloc'
root@ubuntu:/home/test/zlog-1.2.15-arm# vi src/Makefile
将 rpl_realloc 替换为 realloc
root@ubuntu:/home/test/zlog-1.2.15-arm# make clean
root@ubuntu:/home/test/zlog-1.2.15-arm# make 
……
aarch64-linux-gnu-gcc -DPACKAGE_NAME=\&quot;zlog\&quot; -DPACKAGE_TARNAME=\&quot;zlog\&quot; -DPACKAGE_VERSION=\&quot;1.2.7\&quot; -DPACKAGE_STRING=\&quot;zlog\ 1.2.7\&quot; -DPACKAGE_BUGREPORT=\&quot;HardySimpson1984@gmail.com\&quot; -DPACKAGE_URL=\&quot;\&quot; -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\&quot;.libs/\&quot; -DPACKAGE=\&quot;zlog\&quot; -DVERSION=\&quot;1.2.7\&quot; -DHAVE_LIBPTHREAD=1 -DHAVE_FCNTL_H=1 -DHAVE_LIMITS_H=1 -DHAVE_STDINT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_STRINGS_H=1 -DHAVE_SYS_TIME_H=1 -DHAVE_SYSLOG_H=1 -DHAVE_UNISTD_H=1 -DHAVE_FORK=1 -DHAVE_VFORK=1 -DHAVE_WORKING_VFORK=1 -DHAVE_WORKING_FORK=1 -DHAVE_STDLIB_H=1 -DHAVE_REALLOC=0 -Drealloc=realloc -DHAVE_ATEXIT=1 -DHAVE_GETHOSTNAME=1 -DHAVE_GETTIMEOFDAY=1 -DHAVE_LOCALTIME_R=1 -DHAVE_MEMMOVE=1 -DHAVE_MEMSET=1 -DHAVE_SETENV=1 -DHAVE_STRCHR=1 -DHAVE_STRRCHR=1 -DHAVE_STRTOL=1 -I.    -I. -g -O2 -c -o zlog_chk_conf-zlog-chk-conf.o `test -f 'zlog-chk-conf.c' || echo './'`zlog-chk-conf.c
/bin/bash ../libtool  --tag=CC   --mode=link aarch64-linux-gnu-gcc -I. -g -O2   -o zlog-chk-conf zlog_chk_conf-zlog-chk-conf.o libzlog.la -lpthread 
libtool: link: aarch64-linux-gnu-gcc -I. -g -O2 -o .libs/zlog-chk-conf zlog_chk_conf-zlog-chk-conf.o  ./.libs/libzlog.so -lpthread -Wl,-rpath -Wl,/opt/embedded/zlog/lib
make[1]: Leaving directory '/home/test/zlog-1.2.15-arm/src'
Making all in tools
make[1]: Entering directory '/home/test/zlog-1.2.15-arm/tools'
make[1]: Nothing to be done for 'all'.
make[1]: Leaving directory '/home/test/zlog-1.2.15-arm/tools'
Making all in test
make[1]: Entering directory '/home/test/zlog-1.2.15-arm/test'
make[1]: Nothing to be done for 'all'.
make[1]: Leaving directory '/home/test/zlog-1.2.15-arm/test'
make[1]: Entering directory '/home/test/zlog-1.2.15-arm'
make[1]: Nothing to be done for 'all-am'.
make[1]: Leaving directory '/home/test/zlog-1.2.15-arm'
root@ubuntu:/home/test/zlog-1.2.15-arm# make install
libtool: install: /usr/bin/install -c .libs/libzlog.so.1.1.0 /opt/embedded/zlog/lib/libzlog.so.1.1.0
libtool: install: (cd /opt/embedded/zlog/lib &amp;&amp; { ln -s -f libzlog.so.1.1.0 libzlog.so.1 || { rm -f libzlog.so.1 &amp;&amp; ln -s libzlog.so.1.1.0 libzlog.so.1; }; })
libtool: install: (cd /opt/embedded/zlog/lib &amp;&amp; { ln -s -f libzlog.so.1.1.0 libzlog.so || { rm -f libzlog.so &amp;&amp; ln -s libzlog.so.1.1.0 libzlog.so; }; })
libtool: install: /usr/bin/install -c .libs/libzlog.lai /opt/embedded/zlog/lib/libzlog.la
libtool: install: /usr/bin/install -c .libs/libzlog.a /opt/embedded/zlog/lib/libzlog.a
libtool: install: chmod 644 /opt/embedded/zlog/lib/libzlog.a
libtool: install: aarch64-linux-gnu-ranlib /opt/embedded/zlog/lib/libzlog.a
libtool: finish: PATH=&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:/sbin&quot; ldconfig -n /opt/embedded/zlog/lib

root@ubuntu:/home/test# readelf -h /opt/embedded/zlog/lib/libzlog.a
File: /opt/embedded/zlog/lib/libzlog.a(libzlog_la-buf.o)
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 
  Class:                             ELF64
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              REL (Relocatable file)
  Machine:                           AArch64
  Version:                           0x1
  Entry point address:               0x0
  Start of program headers:          0 (bytes into file)
  Start of section headers:          53432 (bytes into file)
  Flags:                             0x0
  Size of this header:               64 (bytes)
  Size of program headers:           0 (bytes)
  Number of program headers:         0
  Size of section headers:           64 (bytes)
  Number of section headers:         24
  Section header string table index: 23 
</code></pre>

<p><a name="section4"></a></p>

<h2 id="四-upf加载">四、UPF加载</h2>

<p>理论上这一步没啥特别，拷贝文件，起网桥，启动VPP。另外这边启动网桥是因为客户对性能没啥要去，所以没有用DPDK接管。DPDK的20.11版本取消了igb_uio.ko，改用原始的vfio-pci，这个还没玩过。</p>

<pre><code class="language-shell">root@nrsys:~# cat installvpp.sh
#!/bin/bash

cd /root/
rm -rf board.release
tar -zxf board.release.tar.gz
cp startup.conf board.release/
cp cmd.txt board.release/
cd board.release/
cp vpp /usr/bin/
cp lib/* /lib/aarch64-linux-gnu/

root@nrsys:~# cat ifconfig.sh 
#!/bin/bash

#UPF N3.
ip link add name veth3 type veth peer name vhosteth3
ip link set dev veth3 up
ip link set dev vhosteth3 up
brctl addif br0 vhosteth3

#UPF N6
ip link add name veth6 type veth peer name vhosteth6
ip link set dev veth6 up
ip link set dev vhosteth6 up
brctl addif br1 vhosteth6

root@nrsys:~/board.release# cat startup.conf
unix {
  interactive
  log /var/log/vpp/vpp.log
  full-coredump
  cli-listen /run/vpp/cli.sock
  exec ./cmd.txt
}

api-trace {
  on
}

cpu {
  main-core 0
  workers 1
}

buffers {
  buffers-per-numa 8000
}

#dpdk {
        #huge-dir /mnt/huge
        #no-pci
        #num-mem-channels 1
        #enable-lookaside-proto-offload

        #dev default {
        #        num-rx-queues 1
        #}
#}

plugins {
        path /root/board.release/vpp_plugins/       
}

root@nrsys:~/board.release# cat cmd.txt
ip  table add 3
ip  table add 6
ip6 table add 3
ip6 table add 6

create host-interface name veth3
set interface ip    table   host-veth3 3
set interface ip6   table   host-veth3 3
set interface ip    address host-veth3 172.16.2.202/24 
set interface state host-veth3 up

create host-interface name veth6
set interface ip    table   host-veth6 6
set interface ip6   table   host-veth6 6
set interface ip    address host-veth6 192.168.2.202/24 
set interface state host-veth6 up
</code></pre>

<p>完事之后ping包测试</p>

<p><img src="https://s2.loli.net/2022/01/28/viM36BsJALDTHUn.png" alt="图片" /></p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"><a href="https://laozhu.me" rel="noopener" target="_blank">Zhanggq</a></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2021-12-25</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a href="https://github.com/gohugoio/hugoBasicExample" rel="noopener" target="_blank">See origin</a></span>
  </p>
</div>

    
    

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/dpdk/">DPDK</a>
          
          <a href="/tags/vpp/">VPP</a>
          
          <a href="/tags/arm/">ARM</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/zgq-dpdk-checksum/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">DPDK的Checksum offload</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/zgq-plat-5-msg-queue/">
            <span class="next-text nav-default">论大型通信软件平台 队列篇</span>
            <span class="prev-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
    

  

  

  <div id="comments-gitment"></div>
  <link rel="stylesheet" href="/lib/gitment/gitment-0.0.3.min.css">
    <script src="/lib/gitment/gitment-0.0.3.min.js"></script>
  <script type="text/javascript">
  const gitment = new Gitment({
    id: 'zgq-dpdk-vpp-arm.md',
    title: 'VPP运行在ARM板上',
    link: decodeURI(location.href),
    desc: '摘要 最近有个项目需要把VPP运行在ARM板子上，本篇文章主要记录一些操作过程： 环境信息； VPP交叉编译； UPF依赖交叉编译； 运行； 一、环境信',
    owner: 'zhanggq',
    repo: 'comments',
    oauth: {
      client_id: 'b88e78d6f966f0edea6e',
      client_secret: '75fea1f9e7412b4a35b1d54dbd217f4e26414499'
    }
  })
  gitment.render('comments-gitment')
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://github.com/imsun/gitment">comments powered by gitment.</a></noscript>
  </article>
        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="zhang_gq@foxmail.com" rel="me" class="iconfont icon-email" title="email"></a>
      <a href="zhang_gq@foxmail.com" rel="me" class="iconfont icon-github" title="github"></a>
  <a href="https://zhanggq.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy; 
    
      2017 - 
    2022
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">zhanggq</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>
<script type="text/javascript" src="/dist/jane.min.js?v=2.7.0"></script>
  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML'></script>





</body>
</html>
